pipeline {
    agent any
    
    environment {
        NEXUS_HOST = 'host.docker.internal:8081'
        CREDENTIALS_ID = 'nexus-creds'
        APP_NAME = 'myapp'
    }
    
    triggers {
        pollSCM('H/1 * * * *')
    }
    
    stages {
        stage('ğŸ“¥ Checkout & Build') {
            steps {
                echo "ğŸ”„ Git ì €ì¥ì†Œì—ì„œ ì†ŒìŠ¤ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
                git branch: 'master', url: 'https://github.com/Daegon7/docker.git'
                
                script {
                    env.GIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.IMAGE_TAG = "${BUILD_NUMBER}-${env.GIT_SHORT}"
                    echo "âœ… ì„¤ì • ì™„ë£Œ: IMAGE_TAG = ${env.IMAGE_TAG}"
                }
                
                sh """
                    echo "ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ..."
                    docker build -t ${APP_NAME}:${IMAGE_TAG} .
                    docker build -t ${APP_NAME}:latest .
                    
                    echo "ğŸ“¦ TAR íŒŒì¼ ìƒì„±..."
                    docker save ${APP_NAME}:${IMAGE_TAG} -o ${APP_NAME}-${IMAGE_TAG}.tar
                    docker save ${APP_NAME}:latest -o ${APP_NAME}-latest.tar
                    
                    echo "âœ… ë¹Œë“œ ì™„ë£Œ:"
                    ls -lh ${APP_NAME}-*.tar
                """
            }
        }
        
        stage('â˜ï¸ Upload to docker-hosted') {
            steps {
                echo "â˜ï¸ docker-hosted ì €ì¥ì†Œì— ì—…ë¡œë“œ ì¤‘..."
                withCredentials([usernamePassword(
                    credentialsId: "${CREDENTIALS_ID}",
                    usernameVariable: 'NEXUS_USER',
                    passwordVariable: 'NEXUS_PASS'
                )]) {
                    sh """
                        echo "=== Nexus ì—°ê²° í…ŒìŠ¤íŠ¸ ==="
                        curl -u \$NEXUS_USER:\$NEXUS_PASS -f "${NEXUS_HOST}/service/rest/v1/status" && echo "âœ… ì—°ê²° ì„±ê³µ"
                        
                        echo "=== docker-hosted ì €ì¥ì†Œì— ì—…ë¡œë“œ ==="
                        
                        # Tagged ë²„ì „ ì—…ë¡œë“œ
                        echo "ğŸ“¤ ${IMAGE_TAG} ë²„ì „ ì—…ë¡œë“œ..."
                        curl -v -u \$NEXUS_USER:\$NEXUS_PASS \\
                             --upload-file ${APP_NAME}-${IMAGE_TAG}.tar \\
                             "${NEXUS_HOST}/repository/docker-hosted/docker-images/${APP_NAME}/${IMAGE_TAG}/${APP_NAME}-${IMAGE_TAG}.tar"
                        
                        # Latest ë²„ì „ ì—…ë¡œë“œ
                        echo "ğŸ“¤ latest ë²„ì „ ì—…ë¡œë“œ..."
                        curl -v -u \$NEXUS_USER:\$NEXUS_PASS \\
                             --upload-file ${APP_NAME}-latest.tar \\
                             "${NEXUS_HOST}/repository/docker-hosted/docker-images/${APP_NAME}/latest/${APP_NAME}-latest.tar"
                        
                        echo "âœ… docker-hosted ì—…ë¡œë“œ ì™„ë£Œ!"
                    """
                }
            }
        }
        
        stage('âœ… Verify Upload') {
            steps {
                echo "ğŸ” ì—…ë¡œë“œ í™•ì¸ ì¤‘..."
                withCredentials([usernamePassword(
                    credentialsId: "${CREDENTIALS_ID}",
                    usernameVariable: 'NEXUS_USER',
                    passwordVariable: 'NEXUS_PASS'
                )]) {
                    sh """
                        echo "=== ì—…ë¡œë“œëœ íŒŒì¼ í™•ì¸ ==="
                        
                        # docker-hosted ì €ì¥ì†Œ ë‚´ìš© í™•ì¸
                        echo "=== docker-hosted ì €ì¥ì†Œ ë‚´ìš© ==="
                        curl -s -u \$NEXUS_USER:\$NEXUS_PASS \\
                             "${NEXUS_HOST}/repository/docker-hosted/" | \\
                             grep -i "${APP_NAME}" || echo "íŒŒì¼ ëª©ë¡ì—ì„œ ${APP_NAME} ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"
                        
                        # íŠ¹ì • íŒŒì¼ ì¡´ì¬ í™•ì¸
                        echo "=== íŒŒì¼ ì¡´ì¬ í™•ì¸ ==="
                        
                        # Tagged ë²„ì „ í™•ì¸
                        HTTP_CODE_TAG=\$(curl -s -o /dev/null -w "%{http_code}" \\
                                         -u \$NEXUS_USER:\$NEXUS_PASS \\
                                         "${NEXUS_HOST}/repository/docker-hosted/docker-images/${APP_NAME}/${IMAGE_TAG}/${APP_NAME}-${IMAGE_TAG}.tar")
                        
                        # Latest ë²„ì „ í™•ì¸
                        HTTP_CODE_LATEST=\$(curl -s -o /dev/null -w "%{http_code}" \\
                                           -u \$NEXUS_USER:\$NEXUS_PASS \\
                                           "${NEXUS_HOST}/repository/docker-hosted/docker-images/${APP_NAME}/latest/${APP_NAME}-latest.tar")
                        
                        if [ "\$HTTP_CODE_TAG" = "200" ]; then
                            echo "âœ… Tagged ë²„ì „ ì—…ë¡œë“œ í™•ì¸: ${APP_NAME}-${IMAGE_TAG}.tar"
                        else
                            echo "âš ï¸ Tagged ë²„ì „ í™•ì¸ ì‹¤íŒ¨ (HTTP: \$HTTP_CODE_TAG)"
                        fi
                        
                        if [ "\$HTTP_CODE_LATEST" = "200" ]; then
                            echo "âœ… Latest ë²„ì „ ì—…ë¡œë“œ í™•ì¸: ${APP_NAME}-latest.tar"
                        else
                            echo "âš ï¸ Latest ë²„ì „ í™•ì¸ ì‹¤íŒ¨ (HTTP: \$HTTP_CODE_LATEST)"
                        fi
                        
                        echo "ğŸ”— Nexusì—ì„œ í™•ì¸: ${NEXUS_HOST}/#browse/browse:docker-hosted"
                    """
                }
            }
        }
        
        stage('ğŸ“Š Summary') {
            steps {
                script {
                    echo """
                    ğŸ‰ ë¹Œë“œ ë° ì—…ë¡œë“œ ì™„ë£Œ!
                    
                    ğŸ“¦ í”„ë¡œì íŠ¸: ${APP_NAME}
                    ğŸ”¢ ë¹Œë“œ ë²ˆí˜¸: ${BUILD_NUMBER}
                    ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸: ${env.IMAGE_TAG}
                    ğŸ“ ì €ì¥ì†Œ: docker-hosted
                    ğŸ“… ë¹Œë“œ ì‹œê°„: ${new Date()}
                    
                    ğŸ”— Nexus í™•ì¸:
                    ${NEXUS_HOST}/#browse/browse:docker-hosted
                    
                    ğŸ“ ì—…ë¡œë“œ ê²½ë¡œ:
                    - docker-images/${APP_NAME}/${env.IMAGE_TAG}/${APP_NAME}-${env.IMAGE_TAG}.tar
                    - docker-images/${APP_NAME}/latest/${APP_NAME}-latest.tar
                    
                    ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë°©ë²•:
                    wget --user=admin --password=admin123 \\
                         "${NEXUS_HOST}/repository/docker-hosted/docker-images/${APP_NAME}/latest/${APP_NAME}-latest.tar"
                    
                    docker load -i ${APP_NAME}-latest.tar
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                try {
                    sh """
                        echo "ğŸ§¹ ì •ë¦¬ ì‘ì—…..."
                        rm -f ${APP_NAME}-*.tar || true
                        docker system prune -f || true
                        echo "âœ… ì •ë¦¬ ì™„ë£Œ"
                    """
                } catch (Exception e) {
                    echo "âš ï¸ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${e.getMessage()}"
                }
            }
        }
        
        success {
            echo """
            ğŸ‰ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!
            
            âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ
            âœ… docker-hosted ì €ì¥ì†Œì— ì—…ë¡œë“œ ì™„ë£Œ
            
            ğŸ“¦ ì—…ë¡œë“œëœ íŒŒì¼:
            - ${APP_NAME}-${env.IMAGE_TAG}.tar
            - ${APP_NAME}-latest.tar
            
            ğŸ”— í™•ì¸: ${NEXUS_HOST}/#browse/browse:docker-hosted
            ğŸ“ ê²½ë¡œ: docker-images/${APP_NAME}/
            """
        }
        
        failure {
            echo """
            ğŸ’¥ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!
            
            ğŸ“‹ í™•ì¸ì‚¬í•­:
            1. docker-hosted ì €ì¥ì†Œ ìƒíƒœ
            2. Nexus ìê²©ì¦ëª… (nexus-creds)
            3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ
            4. íŒŒì¼ ì—…ë¡œë“œ ê¶Œí•œ
            
            ğŸ”— Nexus: ${NEXUS_HOST}/#browse/browse:docker-hosted
            """
        }
    }
}
