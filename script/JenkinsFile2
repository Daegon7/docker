pipeline {
    agent any

    environment {
        NEXUS_HOST = 'host.docker.internal:8081'
        NEXUS_REPO = 'raw-hosted'
        CREDENTIALS_ID = 'nexus-creds'
        APP_NAME = 'myapp'
    }

    triggers {
        pollSCM('H/1 * * * *')
    }

    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo "ğŸ”„ Git ì €ì¥ì†Œì—ì„œ ì†ŒìŠ¤ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
                git branch: 'master', url: 'https://github.com/Daegon7/docker.git'

                script {
                    // ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
                    env.GIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.IMAGE_TAG = "${BUILD_NUMBER}-${env.GIT_SHORT}"

                    echo "âœ… ì„¤ì • ì™„ë£Œ: IMAGE_TAG = ${env.IMAGE_TAG}"
                }
            }
        }

        stage('ğŸ—ï¸ Docker Build') {
            steps {
                echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                sh """
                    docker build -t ${APP_NAME}:${IMAGE_TAG} .
                    docker build -t ${APP_NAME}:latest .
                    echo "âœ… ë¹Œë“œ ì™„ë£Œ: ${APP_NAME}:${IMAGE_TAG}"
                """
            }
        }

        stage('ğŸ“¦ Package') {
            steps {
                echo "ğŸ“¦ Docker ì´ë¯¸ì§€ë¥¼ tar íŒŒì¼ë¡œ íŒ¨í‚¤ì§•..."
                sh """
                    docker save ${APP_NAME}:${IMAGE_TAG} -o ${APP_NAME}-${IMAGE_TAG}.tar
                    docker save ${APP_NAME}:latest -o ${APP_NAME}-latest.tar
                    ls -lh ${APP_NAME}-*.tar
                    echo "âœ… íŒ¨í‚¤ì§• ì™„ë£Œ"
                """
            }
        }

        stage('â˜ï¸ Upload to Nexus') {
            steps {
                echo "â˜ï¸ Nexus Repositoryì— ì—…ë¡œë“œ ì¤‘..."
                withCredentials([usernamePassword(
                    credentialsId: "${CREDENTIALS_ID}",
                    usernameVariable: 'NEXUS_USER',
                    passwordVariable: 'NEXUS_PASS'
                )]) {
                    sh """
                        echo "=== Nexus ì—°ê²° í…ŒìŠ¤íŠ¸ ==="
                        curl -u \$NEXUS_USER:\$NEXUS_PASS -f "${NEXUS_HOST}/service/rest/v1/status" && echo "âœ… ì—°ê²° ì„±ê³µ"

                        echo "=== ì´ë¯¸ì§€ ì—…ë¡œë“œ ==="
                        curl -u \$NEXUS_USER:\$NEXUS_PASS \\
                             --upload-file ${APP_NAME}-${IMAGE_TAG}.tar \\
                             "${NEXUS_HOST}/repository/${NEXUS_REPO}/docker-images/${APP_NAME}/${APP_NAME}-${IMAGE_TAG}.tar"

                        curl -u \$NEXUS_USER:\$NEXUS_PASS \\
                             --upload-file ${APP_NAME}-latest.tar \\
                             "${NEXUS_HOST}/repository/${NEXUS_REPO}/docker-images/${APP_NAME}/${APP_NAME}-latest.tar"

                        echo "âœ… Nexus ì—…ë¡œë“œ ì™„ë£Œ!"
                    """
                }
            }
        }

        stage('ğŸ“Š Summary') {
            steps {
                script {
                    echo """
                    ğŸ‰ ë¹Œë“œ ì„±ê³µ ìš”ì•½:

                    ğŸ“¦ í”„ë¡œì íŠ¸: ${APP_NAME}
                    ğŸ”¢ ë¹Œë“œ ë²ˆí˜¸: ${BUILD_NUMBER}
                    ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸: ${env.IMAGE_TAG}
                    ğŸ“… ë¹Œë“œ ì‹œê°„: ${new Date()}

                    ğŸ”— Nexus: ${NEXUS_HOST}/#browse/browse:${NEXUS_REPO}
                    ğŸ“ ê²½ë¡œ: docker-images/${APP_NAME}/
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                try {
                    sh """
                        echo "ğŸ§¹ ì •ë¦¬ ì‘ì—…..."
                        rm -f ${APP_NAME}-*.tar || true
                        docker system prune -f || true
                        echo "âœ… ì •ë¦¬ ì™„ë£Œ"
                    """
                } catch (Exception e) {
                    echo "âš ï¸ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${e.getMessage()}"
                }
            }
        }

        success {
            echo """
            ğŸ‰ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!

            âœ… ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ
            ğŸ“¦ Docker ì´ë¯¸ì§€ê°€ Nexusì— ì €ì¥ë¨
            ğŸ”— ${NEXUS_HOST}ì—ì„œ í™•ì¸ ê°€ëŠ¥
            """
        }

        failure {
            echo """
            ğŸ’¥ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!

            ğŸ“‹ í™•ì¸ì‚¬í•­:
            1. Docker ì„œë¹„ìŠ¤ ìƒíƒœ
            2. Nexus ì—°ê²° ìƒíƒœ
            3. Git ì €ì¥ì†Œ ì ‘ê·¼ ê¶Œí•œ
            4. ìê²©ì¦ëª… ì„¤ì • (nexus-creds)
            """
        }
    }
}